# Global definitions for Makefile:
# OS, compiler, utils

# Undefine built-in rules, suffixes and variables
MAKEFLAGS += -Rr

# Set OS
ifndef OS
	uname := $(shell uname)
	ifeq "$(uname)" "Linux"
		OS := linux
	else ifeq "$(uname)" "FreeBSD"
		OS := freebsd
	else ifeq "$(uname)" "Darwin"
		OS := apple
	endif
else ifeq "$(OS)" "Windows_NT"
	# OS=Windows_NT is default env var on Windows
	OS := windows
endif

DOTEXE :=
SO := so
ifeq "$(OS)" "apple"
	SO := dylib
else ifeq "$(OS)" "windows"
	DOTEXE := .exe
	SO := dll
endif

# Set CPU arch: amd64 (x86_64), x86 (i686), arm64 (aarch64)
# Note: Windows: must set CPU=... manually
CPU := amd64
ifneq "$(OS)" "windows"
	CPU := $(shell uname -m)
	ifeq "$(CPU)" "x86_64"
		CPU := amd64
	else ifeq "$(CPU)" "i686"
		CPU := x86
	else ifeq "$(CPU)" "aarch64"
		CPU := arm64
	endif
endif

# Set compiler
COMPILER := clang
ifeq "$(OS)" "linux"
	COMPILER := gcc
else ifeq "$(OS)" "windows"
	COMPILER := gcc
endif

CROSS_PREFIX :=
ifndef CROSS_PREFIX
	ifeq "$(OS)" "windows"
		CROSS_PREFIX := x86_64-w64-mingw32-
	endif
endif

C := $(CROSS_PREFIX)gcc -c -pipe
CXX := $(CROSS_PREFIX)g++ -c -pipe
LINK := $(CROSS_PREFIX)gcc -pipe
LINKXX := $(CROSS_PREFIX)g++ -pipe
ifeq "$(COMPILER)" "clang"
	C := clang -c
	CXX := clang++ -c
	LINK := clang
	LINKXX := clang++
endif

LINK_RPATH_ORIGIN :=
LINK_INSTALLNAME_LOADERPATH :=
ifeq "$(OS)" "linux"
	LINK_RPATH_ORIGIN := '-Wl,-rpath,$$ORIGIN' -Wl,--disable-new-dtags
else ifeq "$(OS)" "freebsd"
	LINK_RPATH_ORIGIN := '-Wl,-rpath,$$ORIGIN'
else ifeq "$(OS)" "apple"
	LINK_INSTALLNAME_LOADERPATH = -Wl,-install_name -Wl,@loader_path/$@
endif

LINK_PTHREAD :=
ifneq "$(OS)" "windows"
	LINK_PTHREAD := -pthread
endif

LINKFLAGS :=
ifeq "$(OS)" "linux"
	LINKFLAGS := -Wl,-no-undefined
else ifeq "$(OS)" "freebsd"
	LINKFLAGS := -Wl,-no-undefined
endif
LINKXXFLAGS := $(LINKFLAGS)

# Set utils
AR := $(CROSS_PREFIX)ar
WINDRES := $(CROSS_PREFIX)windres
MKDIR := mkdir -p
RM := rm -rf
CP := cp
ifeq "$(OS)" "linux"
	CP := cp -u
endif
SED := sed -i.old
